DROP TABLE IF EXISTS EVENT_COMPILATIONS CASCADE;
DROP TABLE IF EXISTS COMPILATIONS CASCADE;
DROP TABLE IF EXISTS REQUEST CASCADE;
DROP TABLE IF EXISTS EVENTS CASCADE;
DROP TABLE IF EXISTS CATEGORIES CASCADE;
DROP TABLE IF EXISTS USERS CASCADE;

CREATE TABLE IF NOT EXISTS CATEGORIES(
    ID INT GENERATED BY DEFAULT AS IDENTITY,
    NAME VARCHAR,
    CONSTRAINT PK_CATEGORIES PRIMARY KEY (ID),
    CONSTRAINT UQ_CATEGORY_NAME UNIQUE (NAME)
);

CREATE TABLE IF NOT EXISTS USERS(
    ID INT GENERATED BY DEFAULT AS IDENTITY,
    NAME VARCHAR,
    EMAIL VARCHAR,
    CONSTRAINT PK_USERS PRIMARY KEY (ID),
    CONSTRAINT UQ_USER_EMAIL UNIQUE (EMAIL)
);

CREATE TABLE IF NOT EXISTS EVENTS(
    ID INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    ANNOTATION VARCHAR,
    CATEGORY_ID INT,
    INITIATOR_ID INT,
    TITLE VARCHAR,
    CREATED_ON TIMESTAMP WITH TIME ZONE,
    DESCRIPTION VARCHAR,
    EVENT_DATE TIMESTAMP WITH TIME ZONE,
    PAID BOOLEAN,
    PARTICIPANT_LIMIT INT,
    PUBLISHED_ON TIMESTAMP WITH TIME ZONE,
    STATE VARCHAR DEFAULT 'PENDING',
    LOCATION_LATITUDE FLOAT,
    LOCATION_LONGITUDE FLOAT,
    REQUEST_MODERATION BOOLEAN,
    CONSTRAINT PK_EVENT PRIMARY KEY (ID),
    CONSTRAINT STATE CHECK (STATE IN ('PENDING', 'PUBLISHED', 'CANCELED')),
    FOREIGN KEY (CATEGORY_ID) REFERENCES CATEGORIES(ID) ON DELETE CASCADE,
    FOREIGN KEY (INITIATOR_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS COMPILATIONS(
    ID INT GENERATED BY DEFAULT AS IDENTITY,
    TITLE VARCHAR,
    PINNED BOOLEAN,
    CONSTRAINT PK_COMPILATION PRIMARY KEY (ID)
);

CREATE TABLE IF NOT EXISTS EVENT_COMPILATIONS(
    EVENT_ID INT,
    COMPILATION_ID INT,
    FOREIGN KEY (EVENT_ID) REFERENCES EVENTS (ID) ON DELETE CASCADE,
    FOREIGN KEY (COMPILATION_ID) REFERENCES COMPILATIONS (ID) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS REQUEST(
    ID INT GENERATED BY DEFAULT AS IDENTITY,
    CREATED TIMESTAMP WITH TIME ZONE,
    EVENT_ID INT,
    REQUESTER_ID INT,
    STATUS VARCHAR,
    CONSTRAINT PK_REQUEST PRIMARY KEY (ID),
    FOREIGN KEY (EVENT_ID) REFERENCES EVENTS(ID) ON DELETE CASCADE,
    FOREIGN KEY (REQUESTER_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);