DROP TABLE IF EXISTS EVENT_COMPILATIONS CASCADE;
DROP TABLE IF EXISTS COMPILATIONS CASCADE;
DROP TABLE IF EXISTS REQUEST CASCADE;
DROP TABLE IF EXISTS EVENTS CASCADE;
DROP TABLE IF EXISTS CATEGORIES CASCADE;
DROP TABLE IF EXISTS USERS CASCADE;

CREATE TABLE IF NOT EXISTS CATEGORIES(
    ID INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    NAME VARCHAR(64) NOT NULL,
    CONSTRAINT PK_CATEGORIES PRIMARY KEY (ID),
    CONSTRAINT UQ_CATEGORY_NAME UNIQUE (NAME)
);

CREATE TABLE IF NOT EXISTS USERS(
    ID INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    NAME VARCHAR(64) NOT NULL,
    EMAIL VARCHAR(64) NOT NULL,
    CONSTRAINT PK_USERS PRIMARY KEY (ID),
    CONSTRAINT UQ_USER_EMAIL UNIQUE (EMAIL)
);

CREATE TABLE IF NOT EXISTS EVENTS(
    ID INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    ANNOTATION VARCHAR(200) NOT NULL,
    CATEGORY_ID INT NOT NULL,
    INITIATOR_ID INT NOT NULL,
    TITLE VARCHAR(120) NOT NULL,
    CREATED_ON TIMESTAMP WITH TIME ZONE NOT NULL,
    DESCRIPTION VARCHAR(7000),
    EVENT_DATE TIMESTAMP WITH TIME ZONE NOT NULL,
    PAID BOOLEAN NOT NULL,
    PARTICIPANT_LIMIT INT,
    PUBLISHED_ON TIMESTAMP WITH TIME ZONE NOT NULL,
    STATE VARCHAR(64) NOT NULL DEFAULT 'PENDING',
    LOCATION_LATITUDE FLOAT(24) NOT NULL,
    LOCATION_LONGITUDE FLOAT(24) NOT NULL,
    REQUEST_MODERATION BOOLEAN,
    VIEW INT,
    CONSTRAINT PK_EVENT PRIMARY KEY (ID),
    CONSTRAINT STATE CHECK (STATE IN ('PENDING', 'PUBLISHED', 'CANCELED')),
    FOREIGN KEY (CATEGORY_ID) REFERENCES CATEGORIES(ID) ON DELETE CASCADE,
    FOREIGN KEY (INITIATOR_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS COMPILATIONS(
    ID INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    TITLE VARCHAR(120) NOT NULL,
    PINNED BOOLEAN,
    CONSTRAINT PK_COMPILATION PRIMARY KEY (ID)
);

CREATE TABLE IF NOT EXISTS EVENT_COMPILATIONS(
    EVENT_ID INT NOT NULL,
    COMPILATION_ID INT NOT NULL,
    FOREIGN KEY (EVENT_ID) REFERENCES EVENTS (ID) ON DELETE CASCADE,
    FOREIGN KEY (COMPILATION_ID) REFERENCES COMPILATIONS (ID) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS REQUEST(
    ID INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    CREATED TIMESTAMP WITH TIME ZONE NOT NULL,
    EVENT_ID INT NOT NULL,
    REQUESTER_ID INT NOT NULL,
    STATE VARCHAR(64) NOT NULL DEFAULT 'PENDING',
    CONSTRAINT PK_REQUEST PRIMARY KEY (ID),
    CONSTRAINT STATE CHECK (STATE IN ('PENDING', 'PUBLISHED', 'CANCELED')),
    FOREIGN KEY (EVENT_ID) REFERENCES EVENTS(ID) ON DELETE CASCADE,
    FOREIGN KEY (REQUESTER_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);